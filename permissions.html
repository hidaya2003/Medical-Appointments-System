<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إدارة المستخدمين</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="users.css">
  <link rel="shortcut icon" href="icon-192.png" type="image/png">
  <style>
    .container {
      margin-right: 110px;
    }
    .sidebar .nav-item {
      margin: 8px 10px;
      padding: 10px 4px;
    } 
.container {
  margin-right: 110px;
}

/* تصميم الأزرار */
.action-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-top: 30px;
  margin-bottom: 30px;
}

.action-box {
  background-color: #f7f7f7;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.action-box h3 {
  color: #0d6efd;
  margin-bottom: 20px;
}

.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.action-box button {
  flex: 1;
  min-width: 160px;
  padding: 10px 16px;
  background-color: #0d6efd;
  color: #f7f7f7;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 17px;
  transition: background 0.3s ease;
}

.action-box button:hover {
  background-color: #094bb5;
}

/* النوافذ المنبثقة */
.modal {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      padding: 20px;
      text-align: center;
      overflow-y: auto;
    }

    .modal:before {
      content: '';
      display: inline-block;
      height: 100%;
      vertical-align: middle;
      margin-right: -4px;
    }

    .modal-content {
      direction: rtl;
      background-color: #ffffff;
      border-radius: 15px;
      padding: 25px;
      width: 90%;
      max-width: 500px;
      position: relative;
      text-align: right;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.4s ease-in-out;
      display: inline-block;
      margin: 20px auto;
      vertical-align: middle;
      box-sizing: border-box; 
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
.modal-content h2 {
  color: #2f75e7;
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
  font-size: 1.5rem;
}

.modal-content input,
.modal-content select {
  width: 100%;
  padding: 12px 15px;
  margin-bottom: 15px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  background-color: #f8fafc;
  transition: all 0.3s;
  box-sizing: border-box;
}

.modal-content input:focus,
.modal-content select:focus {
  border-color: #2f75e7;
  outline: none;
  box-shadow: 0 0 0 3px rgba(47, 117, 231, 0.1);
}

.modal-content button {
  background-color: #2f75e7;
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.3s;
  width: 100%;
  margin-top: 10px;
}

.modal-content button:hover {
  background-color: #1e5fd9;
}

.close {
  position: absolute;
  top: 15px;
  left: 15px;
  font-size: 24px;
  color: #888;
  cursor: pointer;
  transition: all 0.3s;
}

.close:hover {
  color: #2f75e7;
  transform: scale(1.1);
}
.request-card {
  background-color: #ffffff;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  border-right: 4px solid #2f75e7;
  transition: all 0.3s ease;
}

.request-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.request-card p {
  margin: 8px 0;
  color: #333;
  font-size: 15px;
}

.request-card strong {
  color: #2f75e7;
  font-weight: 600;
}

.request-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.request-actions button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.request-actions button:first-child {
  background-color: #4CAF50;
  color: white;
}

.request-actions button:first-child:hover {
  background-color: #3e8e41;
}

.request-actions button:last-child {
  background-color: #f44336;
  color: white;
}

.request-actions button:last-child:hover {
  background-color: #d32f2f;
}

/* تحسينات للعنوان */
#requestsModal h2 {
  color: #2f75e7;
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}
/* تحسينات للمودال */


  </style>
</head>
<body>

<!-- القائمة الجانبية -->
<nav class="sidebar">
  <a href="index.html" class="nav-item">
    <i class="fas fa-home"></i>
    <span>الرئيسية</span>
  </a>
  <a href="admin.html" class="nav-item" data-page="dashboard">
    <i class="fas fa-user-injured"></i>
    <span>واجهة المسؤول</span>
  </a>
  <a href="permissions.html" class="nav-item active" data-page="permissions">
    <i class="fas fa-user-shield"></i>
    <span>الصلاحيات</span>
  </a>
  <a href="appointments-admin.html" class="nav-item" data-page="manage-appointments">
    <i class="fas fa-calendar-alt"></i>
    <span>إدارة المواعيد</span>
  </a>
  <a href="adm-profile.html" class="nav-item" data-page="profile">
    <i class="fas fa-user"></i>
    <span>الملف الشخصي</span>
  </a>
  <a href="logout.html" class="nav-item" data-page="logout">
    <i class="fas fa-sign-out-alt"></i>
    <span>تسجيل الخروج</span>
  </a>
</nav>

<div class="container">
  <div class="action-section">
    <div class="action-box">
      <h3>إضافة مستخدم</h3>
      <div class="button-group">
        <button onclick="openModal('addDoctorModal')">إضافة طبيب➕</button>
        <button onclick="openModal('addStaffModal')">إضافة موظف➕</button>
        <button onclick="openModal('addPatientModal')">إضافة مريض➕</button>
      </div>
    </div>
    <div class="action-box">
      <h3>إجراءات أخرى</h3>
      <div class="button-group">
        <button onclick="openModal('deleteModal')">حذف مستخدم ❌</button>
        <button onclick="openModal('editModal')">تعديل بيانات ✏️</button>
        <button onclick="openModal('requestsModal')">الطلبات المعلقة 📥</button>
      </div>
    </div>
  </div>
</div>

<!-- النوافذ المنبثقة -->
<div id="addDoctorModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addDoctorModal')">&times;</span>
    <h2>إضافة طبيب</h2>
    <input id="doctorName" placeholder="الاسم" />
    <input id="doctorNationalId" placeholder="رقم الهوية" />
    <input id="doctorEmployeeId" placeholder="رقم الموظف" />
    <input id="doctorPhone" placeholder="رقم الهاتف" />
    <input id="doctorEmail" type="email" placeholder="البريد الإلكتروني" />
    
    <select id="doctorSpecialtySelect" onchange="handleSpecialtyChange('doctorSpecialtySelect','customSpecialtyInput')">
      <option disabled selected>اختر التخصص</option>
    </select>
    <input type="text" id="customSpecialtyInput" placeholder="أدخل التخصص الجديد" style="display: none;">   
    <button id="addDoctorBtn">إضافة</button>
  </div>
</div>



<div id="addStaffModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addStaffModal')">&times;</span>
    <h2>إضافة موظف</h2>
    <input placeholder="الاسم" />
    <input placeholder="رقم الهوية" />
    <input placeholder="رقم الموظف" />
    <input placeholder="رقم الهاتف" />
    <input type="email" placeholder="البريد الإلكتروني" />
    <button>إضافة</button>
  </div>
</div>

<div id="addPatientModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addPatientModal')">&times;</span>
    <h2>إضافة مريض</h2>
    <input placeholder="الاسم" />
    <input placeholder="رقم الهوية" />
    <input placeholder="رقم الهاتف" />
    <input type="email" placeholder="البريد الإلكتروني" />
    <input type="date" placeholder="تاريخ الميلاد" />
    <select><option>ذكر</option><option>أنثى</option></select>
    <select>
      <option>A+</option><option>A-</option>
      <option>B+</option><option>B-</option>
      <option>AB+</option><option>AB-</option>
      <option>O+</option><option>O-</option>
    </select>
    <button>إضافة</button>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('deleteModal')">&times;</span>
    <h2>حذف مستخدم</h2>
    <input placeholder="رقم الهوية" />
    <button>حذف</button>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('editModal')">&times;</span>
    <h2>تعديل بيانات المستخدم</h2>

    <!-- الرقم الوطني -->
    <label for="nationalIdInput">الرقم الوطني:</label>
    <input type="text" id="nationalIdInput" placeholder="أدخل الرقم الوطني" onblur="loadUserByNationalId()">

    <!-- عرض الدور -->
    <p id="userRoleLabel" style="font-weight: bold; margin-top: 10px;"></p>

    <!-- الحقول التي تظهر بعد التحميل -->
    <div id="editFields" style="display: none; margin-top: 15px;">
      <label for="editName">الاسم:</label>
      <input type="text" id="editName" placeholder="اسم المستخدم">

      <div id="employeeIdSection">
        <label for="editEmployeeId">رقم الموظف:</label>
        <input type="text" id="editEmployeeId" placeholder="رقم الموظف">
      </div>

      <label for="editPhone">رقم الهاتف:</label>
      <input type="text" id="editPhone" placeholder="رقم الهاتف">

      <div id="specialtySection" style="display: none;">
        <label for="specialtySelect">التخصص:</label>
        <select id="specialtySelect">
          <option value="">جاري تحميل التخصصات...</option>
        </select>
      </div>
      <input type="text" id="editCustomSpecialty" placeholder="أدخل التخصص الجديد" style="display: none;">

      <label for="editDateInput">تاريخ الميلاد أو التسجيل:</label>
      <input type="date" id="editDateInput">
      
      <button onclick="submitUserEdit()" style="margin-top: 15px;">تعديل</button>
      <div id="hiddenInputs" style="display:none;">
        <input type="hidden" id="roleSelect">
        <input type="hidden" id="employeeIdInput">
        <input type="hidden" id="nameInput">
        <input type="hidden" id="phoneInput">
        <input type="hidden" id="dateInput">
      </div>
      
    </div>
  </div>
</div>


<div id="requestsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('requestsModal')">&times;</span>
    <h2>الطلبات المعلقة</h2>
    <div id="requestsList">
      <p>جاري تحميل الطلبات...</p>
    </div>
  </div>

<script type="module">  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
  import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
  
  const app = initializeApp({
    apiKey: "AIzaSyCAU6wCvPQwaSBszgfD7PQMgxVw2CyZOK8",
    authDomain: "app-appointment-a2793.firebaseapp.com",
    databaseURL: "https://app-appointment-a2793-default-rtdb.firebaseio.com",
    projectId: "app-appointment-a2793",
    storageBucket: "app-appointment-a2793.appspot.com",
    messagingSenderId: "1015962141540",
    appId: "1:1015962141540:web:70f8a31f3a55e02179f071"
  });
  
  const db = getDatabase(app);
  async function checkNationalIdExists(nationalId) {
    const roles = ["patient", "doctor", "staff"];
    for (const role of roles) {
      const snapshot = await get(ref(db, `users/${role}/${nationalId}`));
      if (snapshot.exists()) return true;
    }
    return false;
  }
  
  // تحقق إذا رقم الموظف مكرر بين الأطباء والموظفين
  async function checkEmployeeIdExists(employeeId) {
    const [doctorsSnap, staffSnap] = await Promise.all([
      get(ref(db, "users/doctor")),
      get(ref(db, "users/staff"))
    ]);
  
    const checkIn = (snapshot) => {
      if (!snapshot.exists()) return false;
      return Object.values(snapshot.val()).some(user => user.employeeId === employeeId);
    };
  
    return checkIn(doctorsSnap) || checkIn(staffSnap);
  }

  // تحقق من بادئة رقم الموظف
  function isValidEmployeePrefix(role, employeeId) {
    const prefixMap = { doctor: "DOC", staff: "STF" };
    return prefixMap[role] ? employeeId.startsWith(prefixMap[role]) : true;
  }

  // جعل الدوال الأساسية متاحة للنطاق العام
window.openModal = function(id) {
  const modal = document.getElementById(id);
  if (!modal) return;
  modal.style.display = "block";

  if (id === "addDoctorModal") {
    loadSpecialtiesFromDoctors("doctorSpecialtySelect");
  }
  if (id === 'requestsModal') {
    loadPendingRequests();
  }
};

window.closeModal = function(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "none";
};

window.clearModalFields = function(modalId) {
  const modal = document.getElementById(modalId);
  if (!modal) return;
  
  const inputs = modal.querySelectorAll("input");
  inputs.forEach(input => {
    input.value = "";
    if (input.type === "text" && input.id.includes("editCustomSpecialty")) {
      input.style.display = "none";
    }
  });

  const selects = modal.querySelectorAll("select");
  selects.forEach(select => {
    select.selectedIndex = 0;
  });
};

window.loadUserByNationalId = async function() {
  const nationalId = document.getElementById("nationalIdInput").value.trim();
  if (!nationalId) return;

  const roles = ["patient", "doctor", "staff"];
  let userData = null;
  let userRole = null;

  for (const role of roles) {
    const snapshot = await get(ref(db, `users/${role}/${nationalId}`));
    if (snapshot.exists()) {
      userData = snapshot.val();
      userRole = role;
      break;
    }
  }

  if (!userData) {
    alert("المستخدم غير موجود");
    return;
  }

  // عرض البيانات في النموذج
  document.getElementById("editName").value = userData.name || "";
  document.getElementById("editPhone").value = userData.phone || "";
  document.getElementById("editDateInput").value = userData.date || "";
  
  if (userRole === "doctor" || userRole === "staff") {
    document.getElementById("editEmployeeId").value = userData.employeeId || "";
    document.getElementById("employeeIdSection").style.display = "block";
  } else {
    document.getElementById("employeeIdSection").style.display = "none";
  }

  if (userRole === "doctor") {
    document.getElementById("specialtySection").style.display = "block";
    await loadSpecialtiesFromDoctors("specialtySelect", userData.specialization);
  } else {
    document.getElementById("specialtySection").style.display = "none";
  }

  document.getElementById("editFields").style.display = "block";
};
//الدالة الثانية
    // تحميل التخصصات الموجودة وإضافتها للقائمة
    window.loadSpecialtiesFromDoctors = async function(selectId, selectedSpecialty = "") {
  try {
    const select = document.getElementById(selectId);
    if (!select) return;
    select.innerHTML = '<option value="" disabled selected>جاري تحميل التخصصات...</option>';
    
    const snapshot = await get(ref(db, "users/doctor"));
    select.innerHTML = '<option value="" disabled selected>اختر التخصص</option>';
    
    if (snapshot.exists()) {
      const specialties = new Set();
      const doctors = snapshot.val();
      Object.values(doctors).forEach(doc => {
        if (doc.specialization) specialties.add(doc.specialization.trim());
      });
      specialties.forEach(spec => {
        const option = document.createElement("option");
        option.value = spec;
        option.textContent = spec;
        if (spec === selectedSpecialty) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    // خيار "أخرى"
    const otherOption = document.createElement("option");
    otherOption.value = "other";
    otherOption.textContent = "أخرى";
    select.appendChild(otherOption);

    // تعيين حدث تغيير لعرض حقل التخصص الجديد
    select.addEventListener("change", () => {
      handleSpecialtyChange(selectId, "editCustomSpecialty");
    });

    // معالجة القيمة المختارة مسبقاً
    handleSpecialtyChange(selectId, "editCustomSpecialty");

  } catch (error) {
    console.error("Error loading specialties:", error);
    const select = document.getElementById(selectId);
    if (select) select.innerHTML = '<option disabled>خطأ في تحميل التخصصات</option>';
  }
};
  // إظهار/إخفاء حقل التخصص الجديد بناءً على اختيار "أخرى"
 /* window.handleSpecialtyChange = function(selectId, inputId) {
    const select = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    if (!select || !input) return;
    input.style.display = select.value === "other" ? "block" : "none";
  };
*/
  // دالة لمسح الحقول بعد الإضافة
  /*function clearModalFields(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    modal.querySelectorAll("input").forEach(input => input.value = "");
    modal.querySelector("select").value = "";
    document.getElementById("customSpecialtyInput").style.display = "none";
  }*/

  // تأكد من أن هذه الدوال متاحة
  window.approveUser = async function(role, nationalId) {
    const userRef = ref(db, `users/${role}/${nationalId}`);
    try {
      await update(userRef, {
        status: "active"
      });
      alert("✅ تم تفعيل الحساب بنجاح");
      loadPendingRequests();
    } catch (e) {
      console.error(e);
      alert("❌ حدث خطأ أثناء تفعيل الحساب");
    }
  };

  window.rejectUser = async function(role, nationalId) {
    const confirmed = confirm("هل أنت متأكد أنك تريد رفض هذا الطلب؟ سيتم حذف الحساب نهائيًا.");
    if (!confirmed) return;

    try {
      await remove(ref(db, `users/${role}/${nationalId}`));
      alert("🗑️ تم حذف الحساب بنجاح");
      loadPendingRequests();
    } catch (e) {
      console.error(e);
      alert("❌ حدث خطأ أثناء حذف الحساب");
    }
  };

  window.loadPendingRequests = async function() {
    const roles = ["doctor", "staff", "admin"];
    const container = document.getElementById("requestsList");
    container.innerHTML = '<div class="loading-spinner"></div>';

    try {
      let hasRequests = false;
      
      for (const role of roles) {
        const snapshot = await get(ref(db, `users/${role}`));
        if (snapshot.exists()) {
          const users = snapshot.val();
          for (const id in users) {
            const user = users[id];
            if (user.status === "pending") {
              hasRequests = true;
              const card = document.createElement("div");
              card.className = "request-card";
              card.innerHTML = `
                <p><strong>الاسم:</strong> ${user.name || 'غير متوفر'}</p>
                <p><strong>النوع:</strong> ${translateRole(role)}</p>
                <p><strong>رقم الهوية:</strong> ${user.nationalId || 'غير متوفر'}</p>
                <p><strong>رقم الموظف:</strong> ${user.employeeId || "غير متوفر"}</p>
                <div class="request-actions">
                  <button onclick="approveUser('${role}', '${user.nationalId}')">
                    <i class="fas fa-check"></i> موافقة
                  </button>
                  <button onclick="rejectUser('${role}', '${user.nationalId}')">
                    <i class="fas fa-times"></i> رفض
                  </button>
                </div>
              `;
              container.appendChild(card);
            }
          }
        }
      }
      
      if (!hasRequests) {
        container.innerHTML = '<p class="no-requests">لا توجد طلبات معلقة حالياً</p>';
      }
      
    } catch (error) {
      container.innerHTML = '<p class="error-message">حدث خطأ أثناء تحميل الطلبات</p>';
      console.error("Error loading requests:", error);
    }
  }


/*  async function loadSpecialties(selectId, selectedSpecialty = "") {
  const select = document.getElementById(selectId);
  if (!select) return;

  select.innerHTML = '<option value="">جاري تحميل التخصصات...</option>';
  const snapshot = await get(ref(db, "users/doctor"));
  
  select.innerHTML = '<option value="">اختر التخصص</option>';
  if (!snapshot.exists()) return;

  const specialties = new Set();
  Object.values(snapshot.val()).forEach(doc => {
    if (doc.specialization) specialties.add(doc.specialization.trim());
  });

  specialties.forEach(spec => {
    const option = new Option(spec, spec);
    if (spec === selectedSpecialty) option.selected = true;
    select.add(option);
  });

  select.add(new Option("أخرى", "other"));
}
*/
// دالة تحميل بيانات المستخدم حسب الرقم الوطني
window.submitUserEdit = async function() {
  const nationalId = document.getElementById("nationalIdInput").value.trim();
  const newName = document.getElementById("editName").value.trim();
  const newPhone = document.getElementById("editPhone").value.trim();
  const newEmployeeId = document.getElementById("editEmployeeId")?.value.trim() || "";
  const selectedSpecialty = document.getElementById("specialtySelect")?.value;
  const customSpecialty = document.getElementById("editCustomSpecialty")?.value.trim() || "";
  const newDate = document.getElementById("editDateInput").value;

  let specialization = selectedSpecialty === "other" ? customSpecialty : selectedSpecialty;

  if (!newName || !newPhone || !newDate) {
    alert("يرجى تعبئة جميع الحقول المطلوبة.");
    return;
  }

  try {
    const roles = ["patient", "doctor", "staff"];
    let currentRole = null;

    // معرفة نوع المستخدم الحالي
    for (const role of roles) {
      const snapshot = await get(ref(db, `users/${role}/${nationalId}`));
      if (snapshot.exists()) {
        currentRole = role;
        break;
      }
    }

    if (!currentRole) {
      alert("المستخدم غير موجود.");
      return;
    }

    // التحقق من تكرار رقم الموظف (للطبيب والموظف فقط)
    if (currentRole === "doctor" || currentRole === "staff") {
      if (!newEmployeeId) {
        alert("يرجى إدخال رقم الموظف");
        return;
      }

      const allDoctorsSnap = await get(ref(db, "users/doctor"));
      const allStaffSnap = await get(ref(db, "users/staff"));

      const allDoctors = allDoctorsSnap.exists() ? allDoctorsSnap.val() : {};
      const allStaff = allStaffSnap.exists() ? allStaffSnap.val() : {};

      for (const id in allDoctors) {
        if (allDoctors[id].employeeId === newEmployeeId && id !== nationalId) {
          alert("⚠️ رقم الموظف مستخدم بالفعل لطبيب آخر.");
          return;
        }
      }

      for (const id in allStaff) {
        if (allStaff[id].employeeId === newEmployeeId && id !== nationalId) {
          alert("⚠️ رقم الموظف مستخدم بالفعل لموظف آخر.");
          return;
        }
      }
    }

    // تعديل البيانات
    const updateData = {
      name: newName,
      phone: newPhone,
      date: newDate,
    };

    if (currentRole === "doctor" || currentRole === "staff") {
      updateData.employeeId = newEmployeeId;
    }

    if (currentRole === "doctor") {
      updateData.specialization = specialization;
    }

    await update(ref(db, `users/${currentRole}/${nationalId}`), updateData);

    alert("✅ تم تعديل بيانات المستخدم بنجاح.");
    document.getElementById("editModal").style.display = "none";
  } catch (error) {
    console.error("Error updating user:", error);
    alert("❌ حدث خطأ أثناء تعديل البيانات.");
  }
};


// ترجمة الأدوار
function translateRole(role) {
  switch(role) {
    case "doctor": return "طبيب";
    case "staff": return "موظف";
    case "admin": return "مسؤول";
    case "patient": return "مريض";
    default: return "غير معروف";
  }
}


// دالة موحدة للتحكم في إظهار/إخفاء خانة التخصص الجديد بناءً على اختيار "أخرى"
window.handleSpecialtyChange = function(selectId, inputId) {
  const select = document.getElementById(selectId);
  const input = document.getElementById(inputId);
  
  if (!select || !input) return;
  
  if (select.value === "other") {
    input.style.display = "block";
  } else {
    input.style.display = "none";
  }
};

// --- إضافة طبيب ---
document.getElementById("addDoctorBtn").addEventListener("click", async () => {
    const name = document.getElementById("doctorName").value.trim();
    const nationalId = document.getElementById("doctorNationalId").value.trim();
    const employeeId = document.getElementById("doctorEmployeeId").value.trim();
    const phone = document.getElementById("doctorPhone").value.trim();
    const email = document.getElementById("doctorEmail").value.trim();
    const specialtySelect = document.getElementById("doctorSpecialtySelect");
    let specialization = specialtySelect.value === "other" ? document.getElementById("customSpecialtyInput").value.trim() : specialtySelect.value;

    // التحقق من تعبئة جميع الحقول
    if (!name || !nationalId || !employeeId || !phone || !email || !specialization) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    // التحقق من وجود رقم الهوية مسبقاً
    if (await checkNationalIdExists(nationalId)) {
      alert("رقم الهوية مسجل مسبقاً.");
      return;
    }

    // التحقق من وجود رقم الموظف مسبقاً
    if (await checkEmployeeIdExists(employeeId)) {
      alert("رقم الموظف مستخدم مسبقاً.");
      return;
    }

    // التحقق من بادئة رقم الموظف
    if (!isValidEmployeePrefix("doctor", employeeId)) {
      alert("❌ رقم الموظف للطبيب يجب أن يبدأ بـ 'DOC'");
      return;
    }

    try {
      await set(ref(db, `users/doctor/${nationalId}`), {
        name,
        nationalId,
        employeeId,
        phone,
        email,
        password: "az123", // كلمة المرور الافتراضية
        specialization,
        role: "doctor",
        status: "active"
      });
      alert("تم إضافة الطبيب بنجاح.");
      clearModalFields("addDoctorModal");
      closeModal("addDoctorModal");
    } catch (e) {
      alert("حدث خطأ أثناء الإضافة.");
      console.error(e);
    }
  });


  // --- إضافة موظف ---
  document.querySelector("#addStaffModal button").addEventListener("click", async () => {
    const modal = document.querySelector("#addStaffModal");
    const name = modal.querySelector("input[placeholder='الاسم']").value.trim();
    const nationalId = modal.querySelector("input[placeholder='رقم الهوية']").value.trim();
    const employeeId = modal.querySelector("input[placeholder='رقم الموظف']").value.trim();
    const phone = modal.querySelector("input[placeholder='رقم الهاتف']").value.trim();
    const email = modal.querySelector("input[placeholder='البريد الإلكتروني']").value.trim();

    if (!name || !nationalId || !employeeId || !phone || !email) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    if (await checkNationalIdExists(nationalId)) {
      alert("رقم الهوية مسجل مسبقاً.");
      return;
    }

    if (await checkEmployeeIdExists(employeeId)) {
      alert("رقم الموظف مستخدم مسبقاً.");
      return;
    }
    if (!isValidEmployeePrefix("staff", employeeId)) {
  alert("❌ رقم الموظف للموظف يجب أن يبدأ بـ 'STF'");
  return;
}


    try {
      await set(ref(db, `users/staff/${nationalId}`), {
        name,
        nationalId,
        employeeId,
        phone,
        email,
        password:"az123",
        role: "staff",
        status: "active"
      });
      alert("تم إضافة الموظف بنجاح.");
      clearModalFields("addStaffModal");
      closeModal("addStaffModal");
    } catch (e) {
      alert("حدث خطأ أثناء الإضافة.");
      console.error(e);
    }
  });

  // --- إضافة مريض ---
  document.querySelector("#addPatientModal button").addEventListener("click", async () => {
    const modal = document.querySelector("#addPatientModal");
    const name = modal.querySelector("input[placeholder='الاسم']").value.trim();
    const nationalId = modal.querySelector("input[placeholder='رقم الهوية']").value.trim();
    const phone = modal.querySelector("input[placeholder='رقم الهاتف']").value.trim();
    const email = modal.querySelector("input[placeholder='البريد الإلكتروني']").value.trim();
    const dob = modal.querySelector("input[placeholder='تاريخ الميلاد']").value;
    const genderSelect = modal.querySelector("select");
    const gender = genderSelect ? genderSelect.value : null;
    const bloodTypeSelect = modal.querySelectorAll("select")[1];
    const bloodType = bloodTypeSelect ? bloodTypeSelect.value : null;

    if (!name || !nationalId || !phone || !email || !dob || !gender || !bloodType) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    if (await checkNationalIdExists(nationalId)) {
      alert("رقم الهوية مسجل مسبقاً.");
      return;
    }

    try {
      await set(ref(db, `users/patient/${nationalId}`), {
        name,
        nationalId,
        phone,
        email,
        dob,
        gender,
        bloodType,
        password:"az123",
        role: "patient",
        status: "active"
      });
      alert("تم إضافة المريض بنجاح.");
      clearModalFields("addPatientModal");
      closeModal("addPatientModal");
    } catch (e) {
      alert("حدث خطأ أثناء الإضافة.");
      console.error(e);
    }
  });

 // --- حذف مستخدم ---
document.querySelector("#deleteModal button").addEventListener("click", async () => {
  const modal = document.querySelector("#deleteModal");
  const nationalId = modal.querySelector("input").value.trim();
  if (!nationalId) {
    alert("يرجى إدخال رقم الهوية.");
    return;
  }

  const confirmed = confirm("هل أنت متأكد أنك تريد حذف هذا المستخدم؟ سيتم نقله إلى سجل المحذوفين.");
  if (!confirmed) return;

  const roles = ["patient", "doctor", "staff"];
  let found = false;

  const deletedBy = localStorage.getItem("adminId") || localStorage.getItem("staffId") || "unknown";
  const deletedAt = new Date().toISOString();

  for (const role of roles) {
    const userRef = ref(db, `users/${role}/${nationalId}`);
    const snap = await get(userRef);
    if (snap.exists()) {
      const userData = snap.val();

      const deletedUserData = {
        ...userData,
        deletedBy,
        deletedAt
      };

      try {
        const deletedRef = ref(db, `deletedUsers/${role}/${nationalId}`);
        await set(deletedRef, deletedUserData);
        await remove(userRef);

        alert(`✅ تم حذف المستخدم من ${role} ونقله إلى السجل.`);
        clearModalFields("deleteModal");
        closeModal("deleteModal");
        found = true;
        break;
      } catch (e) {
        alert("❌ حدث خطأ أثناء الحذف.");
        console.error(e);
        return;
      }
    }
  }

  if (!found) {
    alert("❌ لم يتم العثور على المستخدم.");
  }
});

//الطلبات المعلقة
/*async function loadPendingRequests() {
  const roles = ["doctor", "staff", "admin"];
  const container = document.getElementById("requestsList");
  container.innerHTML = "";

  for (const role of roles) {
    const snapshot = await get(ref(db, `users/${role}`));
    if (snapshot.exists()) {
      const users = snapshot.val();
      for (const id in users) {
        const user = users[id];
        if (user.status === "pending") {
          const card = document.createElement("div");
          card.className = "request-card";
          card.innerHTML = `
            <p><strong>الاسم:</strong> ${user.name}</p>
            <p><strong>النوع:</strong> ${translateRole(role)}</p>
            <p><strong>رقم الهوية:</strong> ${user.nationalId}</p>
            <p><strong>رقم الموظف:</strong> ${user.employeeId || "غير متوفر"}</p>
            <div class="request-actions">
              <button onclick="approveUser('${role}', '${user.nationalId}')"><i class="fas fa-check"></i> موافقة</button>
              <button onclick="rejectUser('${role}', '${user.nationalId}')"><i class="fas fa-times"></i> رفض</button>
            </div>
          `;
          container.appendChild(card);
        }
      }
    }
  }
}*/
// أضف هذا الكود في نهاية السكربت
document.querySelectorAll('[onclick^="openModal"]').forEach(button => {
  const modalId = button.getAttribute('onclick').match(/openModal\('(.+?)'\)/)[1];
  button.removeAttribute('onclick');
  button.addEventListener('click', () => window.openModal(modalId));
});
</script>  
</body>
</html>
