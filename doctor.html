<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="users.css" />
  <link rel="shortcut icon" href="icon-192.png" type="image/png">
  <!-- Firebase App (Core) -->
  <script type="module" src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script type="module" src="https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js"></script>
  <style>
   .doctor-dashboard {
  margin-right: 110px;
  padding: 30px;
  }
    .header {
      margin-bottom: 30px;
    }

    .section {
      width: 95%;
      background-color: #f7f7f7;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 15px;
      margin-top: 0;
      color: #2563eb;
    }

    .section p,
    .section a {
      margin-right: 20px;
    }

    .section a {
      color: #2563eb;
      text-decoration: none;
    }

    .section p span {
     font-weight: bold;
     color: #2563eb;
    }

    .section a:hover {
      text-decoration: underline;
    }

    .appointments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .appointment-card {
      background-color: #f7f7f7;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .appointment-card h3 {
      margin: 0 0 10px;
      color: #2563eb;
    }

    .appointment-card p {
      margin: 5px 0;
      color: #555;
    }

    .appointment-card button {
      margin-top: 15px;
      padding: 10px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 18px;
    }

    .appointment-card button:hover {
      background-color: #1d4ed8;
    }

    .status-pending {
      color: #d97706;
    }

    .status-confirmed {
      color: #065f46;
    }

    .status-canceled {
      color: #dc2626;
    }

    .appointments-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.appointment-card {
  background-color: #f7f7f7;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.appointment-card h3 {
  margin: 0 0 10px;
  color: #2563eb;
}

.appointment-card p {
  margin: 5px 0;
  color: #555;
}

.appointment-card button {
  margin-top: 15px;
  padding: 10px;
  background-color: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s;
  font-size: 18px;
}

.appointment-card button:hover {
  background-color: #1d4ed8;
}

.status-pending {
  color: #d97706;
}

.status-confirmed {
  color: #065f46;
}

.status-canceled {
  color: #dc2626;
}

  </style>  
</head>
<body>
 
<!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
<nav class="sidebar">
  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <a href="index.html" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
  </a>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ - Ù…ÙØ¹Ù‘Ù„Ø© -->
  <a href="doctor.html" class="nav-item active" data-page="dashboard">
    <i class="fas fa-user-md"></i> 
    <span>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</span>
  </a>

  <!-- Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
  <a href="doc-appointments.html" class="nav-item" data-page="appointments">
      <i class="fas fa-calendar-check"></i>
      <span>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</span>
  </a>

  <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
  <a href="D.profile.html" class="nav-item" data-page="profile">
      <i class="fas fa-user"></i>
      <span>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
  </a>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
  <a href="logout.html" class="nav-item" data-page="logout">
      <i class="fas fa-sign-out-alt"></i>
      <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
  </a>
</nav>

<div class="doctor-dashboard">
  <div class="header">
      <h1 class="welcome-message" id="welcomeName">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ !</h1>
      <p id="lastLogin">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: ...</p>
      <p>Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ù‹Ø§ Ù…Ø«Ù…Ø±Ù‹Ø§</p>
  </div>

  <!-- Ø§Ù„ÙŠÙˆÙ… -->
  <div class="section">
    <h2>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</h2>
    <p>ğŸ§â€â™‚ï¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentPatientName">â€”</span> ÙÙŠ <span id="currentAppointmentTime">â€”</span></p>
    <p>â° Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…: <span id="nextAppointmentName">â€”</span> ÙÙŠ <span id="nextAppointmentTime">â€”</span></p>
    <p>ğŸ“Œ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentOrder">â€”</span> Ù…Ù† <span id="appointmentsCount">â€”</span></p>
    <a href="doc-appointments.html">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</a>
  </div>
      

 <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
<div class="section" id="currentPatientInfo" style="display: none;">
  <h2>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
  <p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: <span id="infoName">â€”</span></p>
  <p>ğŸ‚ Ø§Ù„Ø¹Ù…Ø±: <span id="infoAge">â€”</span></p>
  <p>ğŸš» Ø§Ù„Ø¬Ù†Ø³: <span id="infoGender">â€”</span></p>
  <p>ğŸ©¸ ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: <span id="infoBlood">â€”</span></p>
  <p>âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: <span id="infoAllergy">â€”</span></p>
</div>


<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js';
  import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js';
  
  const firebaseConfig = {
    apiKey: "AIzaSyCAU6wCvPQwaSBszgfD7PQMgxVw2CyZOK8",
    authDomain: "app-appointment-a2793.firebaseapp.com",
    databaseURL: "https://app-appointment-a2793-default-rtdb.firebaseio.com",
    projectId: "app-appointment-a2793",
    storageBucket: "app-appointment-a2793.appspot.com",
    messagingSenderId: "1015962141540",
    appId: "1:1015962141540:web:70f8a31f3a55e02179f071"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  
  function convertTo24Hour(timeStr) {
  if (!timeStr) return '';
  const parts = timeStr.trim().split(' ');
  if (parts.length < 2) return timeStr;

  let [time, modifier] = parts;
  modifier = modifier.trim();
  let [hours, minutes] = time.split(':');
  hours = parseInt(hours);

  if (modifier === 'Ù…' && hours < 12) hours += 12;
  if (modifier === 'Øµ' && hours === 12) hours = 0;

  return `${hours.toString().padStart(2, '0')}:${minutes}`;
}

  document.addEventListener('DOMContentLoaded', async () => {
    const doctorName = localStorage.getItem('doctorName');
    const doctorData = JSON.parse(localStorage.getItem('doctorData') || '{}');
  
    if (!doctorName || !doctorData || (!doctorData.employeeId && !doctorData.nationalId)) {
      alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø¨ÙŠØ¨.");
      window.location.href = 'index.html';
      return;
    }
  
    setText('welcomeName', `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø¯. ${doctorName}!`);
    const lastLogin = localStorage.getItem('lastLogin');
    if (lastLogin) {
      const [date, time] = lastLogin.split(' ');
      setText('lastLogin', `Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: ${date} - ${time}`);
    }
  
    const doctorId = doctorData.nationalId || doctorData.employeeId;
    const todayDate = new Date();
    const todayStr = todayDate.toISOString().split('T')[0]; // Ø¨ØµÙŠØºØ© yyyy-mm-dd
    const appointmentsRef = ref(db, `appointments/${doctorId}/${todayStr}`);

    let appointmentsToday = [];
    let currentAppointment = null;
    let nextAppointment = null;
  
    try {
      const snapshot = await get(appointmentsRef);
      if (!snapshot.exists()) {
        setDefaultText();
       
appointmentsToday.forEach(appt => {
  console.log(`- ${appt.time} âœ ${appt.fullDate.toLocaleTimeString()} (${appt.fullDate})`);
});


        return;
      }
  
      const appointmentsData = snapshot.val();
      for (const time in appointmentsData) {
  const appt = appointmentsData[time];

  // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø£Ùˆ Ø§Ù„Ù…Ù„ØºØ§Ø©
  if (!appt || !appt.time || !appt.patientName || appt.cancelledAt) continue;

  const time24 = convertTo24Hour(time);
  const fullDate = new Date(`${todayStr}T${time24}`);

  appointmentsToday.push({
    ...appt,
    time,
    fullDate
  });
}
  
      appointmentsToday.sort((a, b) => a.fullDate - b.fullDate);
const validAppointments = appointmentsToday.filter(a => a.patientName && a.time);
setText('appointmentsCount', validAppointments.length);


      const now = new Date();
      let currentIndex = -1;
  
      appointmentsToday.forEach((appt, index) => {
        const start = appt.fullDate;
        const end = new Date(start.getTime() + 30 * 60000);
  
        if (now >= start && now < end) {
          currentAppointment = appt;
          currentIndex = index + 1;
        } else if (now < start && !nextAppointment) {
          nextAppointment = appt;
        }
      });
  
      if (currentAppointment) {
        setText('currentPatientName', currentAppointment.patientName);
        setText('currentAppointmentTime', currentAppointment.time);
        setText('currentOrder', currentIndex);
        
      } else {
        setText('currentPatientName', "Ù„Ø§ ÙŠÙˆØ¬Ø¯");
        setText('currentAppointmentTime', "â€”");
        setText('currentOrder', "â€”");
      }
  
      if (nextAppointment) {
        setText('nextAppointmentName', nextAppointment.patientName);
        setText('nextAppointmentTime', nextAppointment.time);
        
      } else {
        setText('nextAppointmentName', "Ù„Ø§ ÙŠÙˆØ¬Ø¯");
        setText('nextAppointmentTime', "â€”");
      }
  
      // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (currentAppointment?.patientId || currentAppointment?.nationalId) {
        const patientId = currentAppointment.nationalId || currentAppointment.patientId;
        const patientRef = ref(db, `users/patient/${patientId}`);
        const patientSnap = await get(patientRef);

        function calculateAge(dobStr) {
          if (!dobStr) return 'â€”';
          const dob = new Date(dobStr);
          const diffMs = Date.now() - dob.getTime();
          const ageDt = new Date(diffMs);
          return Math.abs(ageDt.getUTCFullYear() - 1970);
        }

        if (patientSnap.exists()) {
          const data = patientSnap.val();
          setText("infoName", data.name || 'â€”');
          setText("infoAge", calculateAge(data.dob));
          setText("infoGender", data.gender || 'â€”');
          setText("infoBlood", data.bloodType || 'â€”');
          setText("infoAllergy", data.allergy || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
          document.getElementById("currentPatientInfo").style.display = "block";
        }
      }
  
    } catch (err) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:", err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ….");
      setDefaultText();
    }
  
    function setDefaultText() {
      setText('appointmentsCount', "0");
      setText('currentOrder', "â€”");
      setText('currentAppointmentTime', "â€”");
      setText('currentPatientName', "Ù„Ø§ ÙŠÙˆØ¬Ø¯");
      setText('nextAppointmentTime', "â€”");
      setText('nextAppointmentName', "Ù„Ø§ ÙŠÙˆØ¬Ø¯");
    }
  });
  </script>   
<script src="script.js"></script>
</body>
</html>