<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø² - Ù…ÙˆØ¸Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="users.css" />
    <link rel="shortcut icon" href="icon-192.png" type="image/png">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --light: #f8f9fa;
            --dark: #212529;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
        }

        .sidebar .nav-item {
        margin: 8px 10px; 
        padding: 10px 4px; 
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .booking-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            width: 100%;
            justify-content: center; 
            gap: 8px;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .container {
                padding: 15px;
                margin: 20px auto;
            }
        }
    </style>
</head>
<body>
     <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
     <nav class="sidebar">
        <a href="index.html" class="nav-item">
          <i class="fas fa-home"></i>
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
    
        <a href="staff.html" class="nav-item " data-page="dashboard">
          <i class="fas fa-clipboard-list"></i>
          <span>Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
        </a>
    
        <a href="statistics.html" class="nav-item" data-page="statistics">
          <i class="fas fa-chart-bar"></i>
          <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
        </a>
        
        <a href="make-appointment.html" class="nav-item active" data-page="appointment">
          <i class="fas fa-calendar-plus"></i>
          <span>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</span>
        </a>
        
        <a href="stf.profile.html" class="nav-item" data-page="profile">
          <i class="fas fa-user"></i>
          <span>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
        </a>
    
        <a href="logout.html" class="nav-item" data-page="logout">
          <i class="fas fa-sign-out-alt"></i>
          <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
        </a>
      </nav>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calendar-plus"></i> Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h1>
            <p>Ù‚Ù… Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯</p>
        </div>

        <div class="booking-card">
            <form id="bookingForm">
              <div class="form-group">
                <label for="nationalId"><i class="fas fa-id-card"></i> Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶</label>
                <input type="text" id="nationalId" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ" required>
                <small id="patientNameDisplay" style="color:#0d6efd;font-weight:bold;"></small>
              </div>
          
              <div class="form-group">
                <label for="doctor"><i class="fas fa-user-md"></i> Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
                <select id="doctor" class="form-control" required></select>
              </div>
          
              <div class="form-row">
                <div class="form-group">
                  <label for="appointmentDate"><i class="fas fa-calendar-day"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                  <input type="date" id="appointmentDate" class="form-control" required>
                </div>
                <div class="form-group">
                  <label for="appointmentTime"><i class="fas fa-clock"></i> Ø§Ù„ÙˆÙ‚Øª</label>
                  <select id="appointmentTime" class="form-control" required></select>
                </div>
              </div>
          
              <div class="form-group" style="margin-top: 30px;">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯
                </button>
              </div>
            </form>
          </div>
          
          <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
            import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
          
            // ØªÙ‡ÙŠØ¦Ø© Firebase
            const app = initializeApp({
              apiKey: "AIzaSyCAU6wCvPQwaSBszgfD7PQMgxVw2CyZOK8",
              authDomain: "app-appointment-a2793.firebaseapp.com",
              databaseURL: "https://app-appointment-a2793-default-rtdb.firebaseio.com",
              projectId: "app-appointment-a2793",
              storageBucket: "app-appointment-a2793.appspot.com",
              messagingSenderId: "1015962141540",
              appId: "1:1015962141540:web:70f8a31f3a55e02179f071"
            });
          
            const db = getDatabase(app);
          
            // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
            const doctorSelect = document.getElementById("doctor");
            const dateInput = document.getElementById("appointmentDate");
            const timeSelect = document.getElementById("appointmentTime");
            const nationalIdInput = document.getElementById("nationalId");
            const patientNameDisplay = document.getElementById("patientNameDisplay");
          
            let currentPatientName = "";
          
            // Ø¶Ø¨Ø· Ø£Ù‚Ù„ ØªØ§Ø±ÙŠØ® Ù…Ù…ÙƒÙ† Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± (Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ)
            dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
          
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù…Ù† Firebase Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            async function loadDoctors() {
              const doctorsRef = ref(db, "users/doctor");
              const snapshot = await get(doctorsRef);
              doctorSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</option>';
              if (snapshot.exists()) {
                const doctors = snapshot.val();
                for (const id in doctors) {
                  const doc = doctors[id];
                  const option = document.createElement("option");
                  option.value = id;
                  option.textContent = `Ø¯. ${doc.name} - ${doc.specialization || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`;
                  doctorSelect.appendChild(option);
                }
              }
            }
          
            window.addEventListener("DOMContentLoaded", loadDoctors);
          
            // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ
            nationalIdInput.addEventListener("blur", async () => {
              const nationalId = nationalIdInput.value.trim();
              if (!nationalId) {
                patientNameDisplay.textContent = "";
                currentPatientName = "";
                return;
              }
          
              const patientRef = ref(db, `users/patient/${nationalId}`);
              const snap = await get(patientRef);
              if (snap.exists()) {
                currentPatientName = snap.val().name || "";
                patientNameDisplay.textContent = `ğŸ§â€â™‚ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: ${currentPatientName}`;
              } else {
                currentPatientName = "";
                patientNameDisplay.textContent = "";
                alert("âš ï¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
              }
            });
          
            // Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ØªØ§Ø­Ø© - 9 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 4:30 Ù…Ø³Ø§Ø¡Ù‹ Ø¨Ù†ØµÙ Ø³Ø§Ø¹Ø© Ø®Ø·ÙˆØ©ØŒ Ø¨Ù†Ø¸Ø§Ù… 12 Ø³Ø§Ø¹Ø© Ø¹Ø±Ø¨ÙŠ
            const allSlots = [
              "09:00 Øµ", "09:30 Øµ", "10:00 Øµ", "10:30 Øµ", "11:00 Øµ", "11:30 Øµ",
              "12:00 Ù…", "12:30 Ù…", "01:00 Ù…", "01:30 Ù…", "02:00 Ù…", "02:30 Ù…",
              "03:00 Ù…", "03:30 Ù…", "04:00 Ù…", "04:30 Ù…"
            ];
          
            // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª 12 Ø³Ø§Ø¹Ø© Ø¥Ù„Ù‰ 24 Ø³Ø§Ø¹Ø© (Øµ/Ù…)
            function convertTo24Hour(time12h) {
              const [time, period] = time12h.split(" ");
              let [hour, minute] = time.split(":").map(Number);
              if (period === "Ù…" && hour !== 12) hour += 12;
              if (period === "Øµ" && hour === 12) hour = 0;
              return { hour, minute };
            }
          
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© ÙˆØ£ÙˆÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            async function updateAvailableTimes() {
              const doctorId = doctorSelect.value;
              const selectedDate = dateInput.value;
              timeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>';
              if (!doctorId || !selectedDate) return;
          
              // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© Ù„Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±
              const snapshot = await get(ref(db, `appointments/${doctorId}/${selectedDate}`));
              const appointmentsForDate = snapshot.exists() ? snapshot.val() : {};
          
              const takenSlots = Object.keys(appointmentsForDate);
          
              const now = new Date();
              const today = now.toISOString().split("T")[0];
          
              allSlots.forEach(slot => {
                const option = document.createElement("option");
                option.value = slot;
          
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù‡Ù„ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ Ø£Ù… Ù„Ø§ (Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ùˆ Ø§Ù„ÙŠÙˆÙ…)
                const { hour, minute } = convertTo24Hour(slot);
                const slotDate = new Date(`${selectedDate}T${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}:00`);
          
                if (takenSlots.includes(slot) || (selectedDate === today && slotDate < now)) {
                  option.disabled = true;
                  option.textContent = `${slot} (Ù…Ø­Ø¬ÙˆØ²)`;
                  option.style.color = "#999";
                } else {
                  option.textContent = slot;
                }
          
                timeSelect.appendChild(option);
              });
            }
          
            doctorSelect.addEventListener("change", updateAvailableTimes);
            dateInput.addEventListener("change", updateAvailableTimes);
          
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¹Ø¯ Ø³Ø§Ø¨Ù‚ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ù…Ø±ÙŠØ¶
            async function canBookAppointment(nationalId, doctorId, date) {
              if (!nationalId) return false;
              const snapshot = await get(ref(db, `patientAppointments/${nationalId}`));
              if (!snapshot.exists()) return true; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø³Ø§Ø¨Ù‚Ø©
          
              const patientAppointments = snapshot.val();
              for (const key in patientAppointments) {
                const appt = patientAppointments[key];
                if (appt.doctorId === doctorId && appt.date === date) {
                  return false; // ÙˆØ¬Ø¯ Ù…ÙˆØ¹Ø¯ Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø·Ø¨ÙŠØ¨
                }
              }
              return true;
            }
          
            // Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¬Ø²
            document.getElementById("bookingForm").addEventListener("submit", async function (e) {
              e.preventDefault();
          
              const nationalId = nationalIdInput.value.trim();
              const doctorId = doctorSelect.value;
              const date = dateInput.value;
              const time = timeSelect.value;
          
              if (!nationalId || !doctorId || !date || !time) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
                return;
              }
          
              // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              if (!currentPatientName) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶.");
                return;
              }
          
              // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø­Ø¬Ø² Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹
              const slotSnap = await get(ref(db, `appointments/${doctorId}/${date}/${time}`));
              if (slotSnap.exists()) {
                alert("Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø­Ø¬ÙˆØ² Ø¨Ø§Ù„ÙØ¹Ù„.");
                return;
              }
          
              // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¹Ø¯ Ø³Ø§Ø¨Ù‚ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
              const canBook = await canBookAppointment(nationalId, doctorId, date);
              if (!canBook) {
                alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ….");
                return;
              }
          
              // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¹Ø¯
              const doctorSnap = await get(ref(db, `users/doctor/${doctorId}`));
              const doctor = doctorSnap.exists() ? doctorSnap.val() : {};
          
              // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù…ÙˆØ¹Ø¯
              const appointmentId = `${doctorId}_${date}_${time.replace(":", "-")}`;
          
              // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§
              const appointmentData = {
                appointmentId,
                nationalId,
                patientName: currentPatientName,
                doctorId,
                doctorName: doctor.name || "",
                doctorSpecialization: doctor.specialization || "",
                date,
                time, // Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚Øª ÙƒÙ…Ø§ Ù‡Ùˆ (Ø¨Ù†Ø¸Ø§Ù… 12 Ø³Ø§Ø¹Ø©)
                status: "confirmed",
                createdAt: new Date().toISOString()
              };
          
              // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ ØªØ­Øª Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
              await set(ref(db, `appointments/${doctorId}/${date}/${time}`), appointmentData);
          
              // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ ØªØ­Øª Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… appointmentId ÙƒÙ…ÙØªØ§Ø­
              await set(ref(db, `patientAppointments/${nationalId}/${appointmentId}`), appointmentData);
          
              alert("âœ… ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!");
              this.reset();
              patientNameDisplay.textContent = "";
              currentPatientName = "";
              updateAvailableTimes();
            });
          </script>          
                                
</body>
</html>